<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Real-time Monitoring Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0c0c1d 0%, #1a1a2e 50%, #16213e 100%);
            color: #e1e5e9;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #4ade80, transparent);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4ade80, #22d3ee, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            font-weight: 300;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
        }

        .status-dot.healthy {
            background: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .status-dot.warning {
            background: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
        }

        .status-dot.critical {
            background: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .status-dot::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.healthy::after {
            background: rgba(34, 197, 94, 0.4);
        }

        .status-dot.warning::after {
            background: rgba(245, 158, 11, 0.4);
        }

        .status-dot.critical::after {
            background: rgba(239, 68, 68, 0.4);
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Main grid layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4ade80, #22d3ee, #a855f7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dashboard-card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 1.3rem;
        }

        /* Metric display */
        .metric-display {
            text-align: center;
            padding: 20px 0;
        }

        .metric-number {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-number.healthy { color: #22c55e; }
        .metric-number.warning { color: #f59e0b; }
        .metric-number.critical { color: #ef4444; }
        .metric-number.info { color: #22d3ee; }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-change {
            margin-top: 8px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .metric-change.positive { color: #22c55e; }
        .metric-change.negative { color: #ef4444; }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 15px;
        }

        .chart-container.large {
            height: 350px;
        }

        /* Client list */
        .client-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .client-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .client-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .client-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .client-id {
            font-weight: 500;
            color: #f1f5f9;
        }

        .client-details {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .client-metrics {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            font-size: 0.8rem;
        }

        /* Wide layout for charts */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-grid.single {
            grid-template-columns: 1fr;
        }

        /* Loading states */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #4ade80;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .metric-number {
                font-size: 2.5rem;
            }
        }

        /* Connection status banner */
        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .connection-banner.connected {
            background: linear-gradient(90deg, #059669, #0d9488);
            transform: translateY(0);
        }

        .connection-banner.disconnected {
            background: linear-gradient(90deg, #dc2626, #ea580c);
            transform: translateY(0);
        }

        .connection-banner.connecting {
            background: linear-gradient(90deg, #d97706, #f59e0b);
            transform: translateY(0);
        }

        /* Custom scrollbar */
        .client-list::-webkit-scrollbar {
            width: 6px;
        }

        .client-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .client-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .client-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- Connection Status Banner -->
    <div class="connection-banner" id="connectionBanner">
        <span id="connectionText">🔌 Connecting to monitoring system...</span>
    </div>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>🚀 Real-time Monitoring Dashboard</h1>
            <p>Multi-client WebSocket Connection Monitoring</p>
            <div>
                <span class="status-indicator">
                    <span class="status-dot" id="systemStatus"></span>
                    <span id="systemStatusText">Checking system health...</span>
                </span>
                <span class="status-indicator">
                    <span>⚡ Uptime: <span id="uptimeDisplay">--:--:--</span></span>
                </span>
                <span class="status-indicator">
                    <span>🔄 Last Update: <span id="lastUpdateTime">Never</span></span>
                </span>
            </div>
        </div>

        <!-- Main Metrics Grid -->
        <div class="dashboard-grid">
            <!-- System Health -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">❤️</span>
                        System Health
                    </div>
                </div>
                <div class="metric-display">
                    <div class="metric-number healthy" id="healthScore">100</div>
                    <div class="metric-label">Health Score</div>
                    <div class="metric-change" id="healthChange">
                        <span>●</span>
                        <span id="healthStatus">All systems operational</span>
                    </div>
                </div>
            </div>

            <!-- Active Clients -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">👥</span>
                        Active Clients
                    </div>
                </div>
                <div class="metric-display">
                    <div class="metric-number info" id="activeClients">0</div>
                    <div class="metric-label">Connected</div>
                    <div class="metric-change" id="clientChange">
                        <span>📊</span>
                        <span>Peak: <span id="peakClients">0</span></span>
                    </div>
                </div>
            </div>

            <!-- Average Latency -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">⚡</span>
                        Avg Latency
                    </div>
                </div>
                <div class="metric-display">
                    <div class="metric-number" id="avgLatency">0</div>
                    <div class="metric-label">Milliseconds</div>
                    <div class="metric-change" id="latencyChange">
                        <span>🎯</span>
                        <span>Processing + Transcription</span>
                    </div>
                </div>
            </div>

            <!-- Success Rate -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">✅</span>
                        Success Rate
                    </div>
                </div>
                <div class="metric-display">
                    <div class="metric-number healthy" id="successRate">100</div>
                    <div class="metric-label">Percentage</div>
                    <div class="metric-change positive" id="successChange">
                        <span>↗</span>
                        <span>Excellent performance</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="chart-grid">
            <!-- Real-time Latency Chart -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">📈</span>
                        Real-time Latency
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="latencyChart"></canvas>
                </div>
            </div>

            <!-- Device Breakdown -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">📱</span>
                        Device Types
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Clients and Performance -->
        <div class="chart-grid">
            <!-- Active Clients List -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🔗</span>
                        Connected Clients
                    </div>
                </div>
                <div class="client-list" id="clientsList">
                    <div style="text-align: center; padding: 40px; opacity: 0.6;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">👥</div>
                        <div>No clients connected</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">Waiting for WebSocket connections...</div>
                    </div>
                </div>
            </div>

            <!-- System Performance Chart -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🚀</span>
                        System Performance
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Advanced Monitoring & Management -->
        <div class="chart-grid">
            <!-- State Validation -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🔍</span>
                        State Validation
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="validateState()">🔍 Check</button>
                        <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="analyzeTimeouts()">⏰ Timeouts</button>
                    </div>
                </div>
                <div id="stateValidation" style="min-height: 220px; padding: 15px; font-size: 0.9rem;">
                    <div style="text-align: center; opacity: 0.6; padding: 40px 0;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">🔍</div>
                        <div>Click "Check" to validate system state consistency</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">ConnectionManager vs Metrics validation</div>
                    </div>
                </div>
            </div>

            <!-- SPSC Performance Controls -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">🚀</span>
                        SPSC Performance
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn success" style="padding: 6px 12px; font-size: 12px;" onclick="checkTranscriberStatus()">📊 Status</button>
                        <button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="toggleSPSC()" id="spscToggleBtn">🚀 Enable SPSC</button>
                    </div>
                </div>
                <div id="spscControls" style="min-height: 220px; padding: 15px; font-size: 0.9rem;">
                    <div style="text-align: center; opacity: 0.6; padding: 40px 0;">
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">🚀</div>
                        <div>SPSC Legacy Genius Performance System</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">Hot-swap between standard and 10x faster SPSC</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ws = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectInterval = 3000;

        // Chart instances
        let latencyChart = null;
        let deviceChart = null;
        let performanceChart = null;

        // Data storage
        let latencyData = [];
        let maxDataPoints = 20;
        let lastUpdate = null;

        // RFC compliant heartbeat variables
        let heartbeatInterval = null;
        let lastPongReceived = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            connectWebSocket();
            startDataPolling();
            updateTimestamp();
            setInterval(updateTimestamp, 1000);
        });

        function updateTimestamp() {
            const now = new Date();
            if (lastUpdate) {
                document.getElementById('lastUpdateTime').textContent = lastUpdate.toLocaleTimeString();
            }
        }

        function initializeCharts() {
            // Latency Chart
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');
            latencyChart = new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Processing Latency',
                        data: [],
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Transcription Latency',
                        data: [],
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e1e5e9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            // Device Chart
            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            deviceChart = new Chart(deviceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['No devices'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['#374151'],
                        borderColor: ['#4b5563'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e1e5e9' }
                        }
                    }
                }
            });

            // Performance Chart
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['Connections', 'Transcriptions', 'Errors'],
                    datasets: [{
                        label: 'System Stats',
                        data: [0, 0, 0],
                        backgroundColor: ['#4ade80', '#22d3ee', '#ef4444'],
                        borderColor: ['#22c55e', '#0891b2', '#dc2626'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e1e5e9' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        function connectWebSocket() {
            const banner = document.getElementById('connectionBanner');
            const text = document.getElementById('connectionText');

            banner.className = 'connection-banner connecting';
            text.textContent = '🔌 Connecting to monitoring system...';

            try {
                // First get auth token for WebSocket
                fetch('/api/auth/ws-token', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.token) {
                        // Use monitoring WebSocket endpoint instead of main WS
                        const wsUrl = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                        ws = new WebSocket(`${wsUrl}//${window.location.host}/ws-monitor`);
                        setupWebSocketHandlers();
                    } else {
                        throw new Error('No WebSocket token received');
                    }
                })
                .catch(error => {
                    console.error('Failed to get WebSocket token:', error);
                    // Fallback to polling only
                    banner.className = 'connection-banner disconnected';
                    text.textContent = '⚠️ WebSocket unavailable - using polling mode';
                    setTimeout(() => {
                        banner.style.transform = 'translateY(-100%)';
                    }, 3000);
                });
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                banner.className = 'connection-banner disconnected';
                text.textContent = '❌ Connection failed - using polling mode';
            }
        }

        function setupWebSocketHandlers() {
            const banner = document.getElementById('connectionBanner');
            const text = document.getElementById('connectionText');

            ws.onopen = function() {
                console.log('WebSocket connected');
                banner.className = 'connection-banner connected';
                text.textContent = '✅ Real-time monitoring active';
                reconnectAttempts = 0;

                // Start RFC compliant heartbeat - client sends pings
                startHeartbeat();

                setTimeout(() => {
                    banner.style.transform = 'translateY(-100%)';
                }, 2000);
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketData(data);
                } catch (error) {
                    console.error('Failed to parse WebSocket data:', error);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');

                // Stop heartbeat when disconnected
                stopHeartbeat();

                if (reconnectAttempts < maxReconnectAttempts) {
                    banner.className = 'connection-banner connecting';
                    text.textContent = `🔄 Reconnecting... (${reconnectAttempts + 1}/${maxReconnectAttempts})`;
                    banner.style.transform = 'translateY(0)';

                    setTimeout(() => {
                        reconnectAttempts++;
                        connectWebSocket();
                    }, reconnectInterval);
                } else {
                    banner.className = 'connection-banner disconnected';
                    text.textContent = '❌ WebSocket disconnected - using polling mode';
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        function handleWebSocketData(data) {
            // RFC compliant: Handle pong responses from server
            if (data.type === 'pong') {
                console.log('💓 Heartbeat: Server responded to our ping');
                lastPongReceived = Date.now();
                return;
            }

            if (data.type === 'dashboard_data') {
                updateDashboard(data.data);
            } else if (data.type === 'event') {
                console.log('Monitoring event:', data);
            }
        }

        async function startDataPolling() {
            // Fetch initial data
            try {
                const response = await fetch('/api/monitoring/dashboard');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
            }

            // Poll every 5 seconds as fallback
            setInterval(async () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    try {
                        const response = await fetch('/api/monitoring/dashboard');
                        const data = await response.json();
                        updateDashboard(data);
                    } catch (error) {
                        console.error('Polling failed:', error);
                    }
                }
            }, 5000);
        }

        function updateDashboard(data) {
            lastUpdate = new Date();

            // Update system health
            updateSystemHealth(data.system_health);

            // Update main metrics
            updateMainMetrics(data);

            // Update charts
            updateLatencyChart(data.performance);
            updateDeviceChart(data.device_breakdown);
            updatePerformanceChart(data);

            // Update clients list
            updateClientsList(data.queue_status);

            // Update uptime
            updateUptime(data.uptime_seconds);
        }

        function updateSystemHealth(health) {
            const statusElement = document.getElementById('systemStatus');
            const statusText = document.getElementById('systemStatusText');
            const scoreElement = document.getElementById('healthScore');
            const changeElement = document.getElementById('healthChange');

            const score = health.score || 100;
            scoreElement.textContent = score;

            if (score >= 90) {
                statusElement.className = 'status-dot healthy';
                statusText.textContent = 'System Healthy';
                scoreElement.className = 'metric-number healthy';
                changeElement.innerHTML = '<span>●</span><span>All systems operational</span>';
            } else if (score >= 70) {
                statusElement.className = 'status-dot warning';
                statusText.textContent = 'Performance Warning';
                scoreElement.className = 'metric-number warning';
                changeElement.innerHTML = '<span>⚠</span><span>Minor issues detected</span>';
            } else {
                statusElement.className = 'status-dot critical';
                statusText.textContent = 'Critical Issues';
                scoreElement.className = 'metric-number critical';
                changeElement.innerHTML = '<span>❌</span><span>Immediate attention needed</span>';
            }
        }

        function updateMainMetrics(data) {
            // Active clients
            const activeClients = data.active_clients || 0;
            document.getElementById('activeClients').textContent = activeClients;
            document.getElementById('peakClients').textContent = data.system_health?.peak_concurrent || 0;

            // Update client change indicator with more context
            const clientChangeElement = document.getElementById('clientChange');
            if (activeClients > 0) {
                const deviceTypes = Object.entries(data.device_breakdown || {})
                    .map(([type, count]) => `${count} ${type}`)
                    .join(', ') || `${activeClients} connected`;
                clientChangeElement.innerHTML = `<span>📊</span><span>${deviceTypes}</span>`;
            } else {
                clientChangeElement.innerHTML = '<span>📊</span><span>No connections</span>';
            }

            // Average latency
            const avgProcessing = data.performance?.avg_processing_latency_ms || 0;
            const avgTranscription = data.performance?.avg_transcription_latency_ms || 0;
            const totalLatency = avgProcessing + avgTranscription;

            const latencyElement = document.getElementById('avgLatency');
            latencyElement.textContent = Math.round(totalLatency) + 'ms';

            if (totalLatency < 500) {
                latencyElement.className = 'metric-number healthy';
            } else if (totalLatency < 1500) {
                latencyElement.className = 'metric-number warning';
            } else {
                latencyElement.className = 'metric-number critical';
            }

            // Success rate
            const successRate = Math.round((data.performance?.overall_success_rate || 1) * 100);
            const successElement = document.getElementById('successRate');
            successElement.textContent = successRate + '%';

            if (successRate >= 95) {
                successElement.className = 'metric-number healthy';
            } else if (successRate >= 85) {
                successElement.className = 'metric-number warning';
            } else {
                successElement.className = 'metric-number critical';
            }
        }

        function updateLatencyChart(performance) {
            if (!latencyChart) return;

            const time = new Date().toLocaleTimeString();
            const processingLatency = performance?.avg_processing_latency_ms || 0;
            const transcriptionLatency = performance?.avg_transcription_latency_ms || 0;

            // Add new data point
            latencyChart.data.labels.push(time);
            latencyChart.data.datasets[0].data.push(processingLatency);
            latencyChart.data.datasets[1].data.push(transcriptionLatency);

            // Keep only last N data points
            if (latencyChart.data.labels.length > maxDataPoints) {
                latencyChart.data.labels.shift();
                latencyChart.data.datasets[0].data.shift();
                latencyChart.data.datasets[1].data.shift();
            }

            latencyChart.update('none');
        }

        function updateDeviceChart(deviceBreakdown) {
            if (!deviceChart) return;

            const desktop = deviceBreakdown?.desktop || 0;
            const mobile = deviceBreakdown?.mobile || 0;
            const total = desktop + mobile;

            console.log('Device breakdown update:', { desktop, mobile, total, deviceBreakdown });

            // If no devices, show empty state
            if (total === 0) {
                deviceChart.data.labels = ['No devices connected'];
                deviceChart.data.datasets[0].data = [1];
                deviceChart.data.datasets[0].backgroundColor = ['#374151'];
                deviceChart.data.datasets[0].borderColor = ['#4b5563'];
            } else {
                // Only show categories that have devices
                const labels = [];
                const data = [];
                const backgroundColors = [];
                const borderColors = [];

                if (desktop > 0) {
                    labels.push(`Desktop (${desktop})`);
                    data.push(desktop);
                    backgroundColors.push('#4ade80');
                    borderColors.push('#22c55e');
                }

                if (mobile > 0) {
                    labels.push(`Mobile (${mobile})`);
                    data.push(mobile);
                    backgroundColors.push('#22d3ee');
                    borderColors.push('#0891b2');
                }

                deviceChart.data.labels = labels;
                deviceChart.data.datasets[0].data = data;
                deviceChart.data.datasets[0].backgroundColor = backgroundColors;
                deviceChart.data.datasets[0].borderColor = borderColors;
            }

            deviceChart.update();
        }

        function updatePerformanceChart(data) {
            if (!performanceChart) return;

            const connections = data.active_clients || 0;
            const transcriptions = data.system_health?.transcription_rate || 0;
            const errors = data.system_health?.total_errors || 0;

            performanceChart.data.datasets[0].data = [connections, transcriptions, errors];
            performanceChart.update();
        }

        function updateClientsList(queueStatus) {
            const container = document.getElementById('clientsList');

            if (!queueStatus || Object.keys(queueStatus).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.6;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">👥</div>
                        <div>No active audio clients</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">
                            Connected WebSocket clients appear here when processing audio
                        </div>
                    </div>
                `;
                return;
            }

            const clientsHtml = Object.entries(queueStatus).map(([clientId, metrics]) => {
                const deviceIcon = metrics.device_type === 'desktop' ? '🖥️' :
                                   metrics.device_type === 'mobile' ? '📱' : '💻';
                const latencyColor = metrics.avg_latency_ms < 500 ? '#22c55e' :
                                   metrics.avg_latency_ms < 1500 ? '#f59e0b' : '#ef4444';

                return `
                    <div class="client-item">
                        <div class="client-info">
                            <div class="client-id">${deviceIcon} ${clientId.substring(0, 12)}...</div>
                            <div class="client-details">
                                ${metrics.device_type || 'unknown'} •
                                ${Math.round(metrics.connection_duration || 0)}s connected
                            </div>
                        </div>
                        <div class="client-metrics">
                            <div style="color: ${latencyColor}">⚡ ${Math.round(metrics.avg_latency_ms || 0)}ms</div>
                            <div>📋 Queue: ${metrics.size || 0}</div>
                            <div>✅ ${Math.round((metrics.success_rate || 1) * 100)}%</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = clientsHtml;
        }

        function updateUptime(uptimeSeconds) {
            const hours = Math.floor(uptimeSeconds / 3600);
            const minutes = Math.floor((uptimeSeconds % 3600) / 60);
            const seconds = Math.floor(uptimeSeconds % 60);

            const uptimeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('uptimeDisplay').textContent = uptimeStr;
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden, reduce update frequency
                console.log('Page hidden - reducing update frequency');
            } else {
                // Page is visible, resume normal updates
                console.log('Page visible - resuming normal updates');
                // Force refresh
                startDataPolling();
            }
        });

        // Advanced monitoring functions
        async function validateState() {
            const container = document.getElementById('stateValidation');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Validating state...</div>';

            try {
                const response = await fetch('/api/monitoring/validate-state');
                const data = await response.json();

                const statusColor = data.validation_status === 'healthy' ? '#22c55e' :
                                   data.validation_status === 'inconsistent' ? '#f59e0b' : '#ef4444';

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="color: ${statusColor}; font-size: 1.2rem;">●</span>
                            <strong>${data.validation_status.toUpperCase()}</strong>
                            <span style="margin-left: auto; color: #22d3ee;">${data.consistency_score}% consistent</span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                            <div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">CONNECTION MANAGER</div>
                                <div style="font-size: 1.2rem; color: #4ade80;">${data.connection_manager.active_connections} active</div>
                            </div>
                            <div>
                                <div style="color: #94a3b8; font-size: 0.8rem;">METRICS SYSTEM</div>
                                <div style="font-size: 1.2rem; color: #22d3ee;">${data.metrics_system.tracked_clients} tracked</div>
                            </div>
                        </div>
                        ${data.recommendations.map(rec => `<div style="color: #94a3b8; font-size: 0.8rem;">💡 ${rec}</div>`).join('')}
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Last check: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                `;

            } catch (error) {
                container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">❌ State validation failed: ${error.message}</div>`;
            }
        }

        async function analyzeTimeouts() {
            const container = document.getElementById('stateValidation');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Analyzing timeouts...</div>';

            try {
                const response = await fetch('/api/monitoring/timeout-analysis');
                const data = await response.json();

                const summary = data.summary;
                const clients = data.clients || [];

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="margin-bottom: 15px;">
                            <strong>Timeout Analysis (${data.timeout_threshold_seconds}s threshold)</strong>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
                            <div style="text-align: center;">
                                <div style="color: #22c55e; font-size: 1.5rem;">${summary.healthy_clients}</div>
                                <div style="font-size: 0.8rem; color: #94a3b8;">Healthy</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #f59e0b; font-size: 1.5rem;">${summary.timed_out_clients}</div>
                                <div style="font-size: 0.8rem; color: #94a3b8;">Timed Out</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #ef4444; font-size: 1.5rem;">${summary.stale_connections}</div>
                                <div style="font-size: 0.8rem; color: #94a3b8;">Stale</div>
                            </div>
                        </div>
                        ${data.warnings.length > 0 ?
                            data.warnings.map(w => `<div style="color: #f59e0b; font-size: 0.8rem; margin: 2px 0;">⚠️ ${w}</div>`).join('') :
                            '<div style="color: #22c55e; font-size: 0.8rem;">✅ All clients healthy</div>'
                        }
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Analysis: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                `;

            } catch (error) {
                container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">❌ Timeout analysis failed: ${error.message}</div>`;
            }
        }

        async function analyzeCleanup() {
            const container = document.getElementById('cleanupControls');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Analyzing cleanup needs...</div>';

            try {
                // First check state validation
                const stateResponse = await fetch('/api/monitoring/validate-state');
                const stateData = await stateResponse.json();

                // Then check what cleanup would do (without confirmation)
                const cleanupResponse = await fetch('/api/monitoring/cleanup-stale', { method: 'POST' });
                const cleanupData = await cleanupResponse.json();

                const needsCleanup = stateData.consistency_score < 100;
                const staleCount = stateData.inconsistencies.only_in_metrics.length;

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="color: ${needsCleanup ? '#f59e0b' : '#22c55e'}; font-size: 1.2rem;">●</span>
                            <strong>${needsCleanup ? 'Cleanup Recommended' : 'System Clean'}</strong>
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="color: #94a3b8; font-size: 0.8rem;">STALE CLIENTS</div>
                            <div style="font-size: 1.5rem; color: ${staleCount > 0 ? '#f59e0b' : '#22c55e'};">${staleCount}</div>
                        </div>
                        ${needsCleanup ?
                            `<div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px; margin: 10px 0;">
                                <div style="color: #f59e0b; font-size: 0.8rem; margin-bottom: 5px;">⚠️ Cleanup Available</div>
                                <div style="font-size: 0.8rem;">Found ${staleCount} stale client(s) in metrics system</div>
                            </div>` :
                            '<div style="color: #22c55e; font-size: 0.8rem;">✅ No cleanup needed - state is consistent</div>'
                        }
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Analysis: ${new Date().toLocaleTimeString()}</div>
                `;

                // Enable/disable cleanup button based on need
                const cleanupBtn = document.getElementById('cleanupBtn');
                cleanupBtn.disabled = !needsCleanup;
                cleanupBtn.style.opacity = needsCleanup ? '1' : '0.5';

            } catch (error) {
                container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">❌ Cleanup analysis failed: ${error.message}</div>`;
            }
        }

        async function confirmCleanup() {
            if (!confirm('Are you sure you want to cleanup stale clients? This will remove them from metrics tracking.')) {
                return;
            }

            const container = document.getElementById('cleanupControls');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Executing cleanup...</div>';

            try {
                const response = await fetch('/api/monitoring/cleanup-stale?confirm=true', { method: 'POST' });
                const data = await response.json();

                const statusColor = data.status === 'cleanup_completed' ? '#22c55e' :
                                   data.status === 'no_action_needed' ? '#22d3ee' : '#ef4444';

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="color: ${statusColor}; font-size: 1.2rem;">●</span>
                            <strong>${data.status.replace('_', ' ').toUpperCase()}</strong>
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="color: #e1e5e9; font-weight: 500;">${data.message}</div>
                        </div>
                        ${data.cleanup_details ?
                            `<div style="background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 6px; margin: 10px 0; max-height: 100px; overflow-y: auto;">
                                ${data.cleanup_details.map(detail => `<div style="font-size: 0.8rem; margin: 2px 0;">${detail}</div>`).join('')}
                            </div>` : ''
                        }
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Completed: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                `;

                // Refresh dashboard data after cleanup
                setTimeout(() => {
                    startDataPolling();
                }, 1000);

            } catch (error) {
                container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">❌ Cleanup failed: ${error.message}</div>`;
            }
        }

        function refreshClientList() {
            // Force refresh of client data
            startDataPolling();
        }

        // RFC Compliant Heartbeat Functions
        function startHeartbeat() {
            // Client sends pings to server every 30 seconds (RFC compliant)
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }

            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const pingMessage = JSON.stringify({
                        type: 'ping',
                        timestamp: Date.now()
                    });
                    ws.send(pingMessage);
                    console.log('💓 Heartbeat: Sent ping to server');
                }
            }, 30000); // Every 30 seconds

            console.log('💓 RFC compliant heartbeat started (client sends pings)');
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
                console.log('💔 Heartbeat stopped');
            }
        }

        // SPSC Hot-Swap Functions
        async function checkTranscriberStatus() {
            const container = document.getElementById('spscControls');
            container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> Checking transcriber status...</div>';

            try {
                const response = await fetch('/api/monitoring/transcriber-status');
                const data = await response.json();

                const currentType = data.current_type;
                const isSpsc = currentType === 'spsc';
                const statusColor = isSpsc ? '#22c55e' : '#22d3ee';

                // Update toggle button
                const toggleBtn = document.getElementById('spscToggleBtn');
                toggleBtn.textContent = isSpsc ? '📝 Switch to Standard' : '🚀 Enable SPSC';
                toggleBtn.className = isSpsc ? 'btn' : 'btn success';

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="color: ${statusColor}; font-size: 1.2rem;">●</span>
                            <strong>${currentType.toUpperCase()} TRANSCRIBER ACTIVE</strong>
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="color: #94a3b8; font-size: 0.8rem;">PERFORMANCE MODE</div>
                            <div style="font-size: 1.2rem; color: ${statusColor};">
                                ${isSpsc ? 'High-Performance Batching' : 'Simple Sequential'}
                            </div>
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 8px;">ACTIVE FEATURES:</div>
                            ${isSpsc ?
                                `<div style="font-size: 0.8rem;">
                                    ✅ Zero-latency smart batching<br>
                                    ✅ 10x parallel processing<br>
                                    ✅ Circuit breaker resilience<br>
                                    ✅ Per-client smart aggregation
                                </div>` :
                                `<div style="font-size: 0.8rem;">
                                    📝 Simple sequential processing<br>
                                    📝 Low resource usage<br>
                                    📝 Predictable behavior
                                </div>`
                            }
                        </div>
                        <div style="background: rgba(34, 211, 238, 0.1); padding: 10px; border-radius: 6px; margin: 10px 0;">
                            <div style="color: #22d3ee; font-size: 0.8rem; margin-bottom: 5px;">💡 Hot-Swap Available</div>
                            <div style="font-size: 0.8rem;">Switch transcriber types without server restart</div>
                        </div>
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Status: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                `;

            } catch (error) {
                container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">❌ Status check failed: ${error.message}</div>`;
            }
        }

        async function toggleSPSC() {
            // Get current status first
            const statusResponse = await fetch('/api/monitoring/transcriber-status');
            const statusData = await statusResponse.json();
            const currentType = statusData.current_type;
            const targetType = currentType === 'spsc' ? 'standard' : 'spsc';

            const container = document.getElementById('spscControls');
            container.innerHTML = `<div style="text-align: center; padding: 20px;"><div class="loading"></div> Switching to ${targetType}...</div>`;

            try {
                const response = await fetch(`/api/monitoring/switch-transcriber?target_type=${targetType}`, {
                    method: 'POST'
                });
                const data = await response.json();

                const statusColor = data.success ? '#22c55e' : '#ef4444';
                const newType = data.new_type || targetType;

                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="color: ${statusColor}; font-size: 1.2rem;">●</span>
                            <strong>${data.success ? 'SWITCH SUCCESSFUL' : 'SWITCH FAILED'}</strong>
                        </div>
                        <div style="margin: 15px 0;">
                            <div style="color: #e1e5e9; font-weight: 500;">${data.message}</div>
                        </div>
                        ${data.features ?
                            `<div style="background: rgba(34, 197, 94, 0.1); padding: 10px; border-radius: 6px; margin: 10px 0;">
                                <div style="color: #22c55e; font-size: 0.8rem; margin-bottom: 5px;">🚀 Active Features:</div>
                                ${data.features.map(f => `<div style="font-size: 0.8rem;">✅ ${f}</div>`).join('')}
                            </div>` : ''
                        }
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Switched: ${new Date(data.timestamp).toLocaleTimeString()}</div>
                `;

                // Update button for next switch
                const toggleBtn = document.getElementById('spscToggleBtn');
                const isSpsc = newType === 'spsc';
                toggleBtn.textContent = isSpsc ? '📝 Switch to Standard' : '🚀 Enable SPSC';
                toggleBtn.className = isSpsc ? 'btn' : 'btn success';

                // Refresh dashboard data after switch
                setTimeout(() => {
                    startDataPolling();
                }, 1000);

            } catch (error) {
                container.innerHTML = `<div style="color: #ef4444; text-align: center; padding: 20px;">❌ Switch failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>